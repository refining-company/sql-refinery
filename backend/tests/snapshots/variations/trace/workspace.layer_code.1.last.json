{
  "code.Code(files=3)": {
    "files": {
      "0-accounts.sql": [
        { "code.Query(0-accounts.sql:78:0-111:6) = SELECT t.*, CASE WHEN t.revenue_12m <= 300 THEN 'Small' WHEN t.revenue_12m > ...": {
            "expressions": [
              "code.Expression(0-accounts.sql:80:4-85:7) = CASE WHEN t.revenue_12m <= 300 THEN 'Small' WHEN t.revenue_12m > 300 AND t.re..." ],
            "location": "code.Location = 0-accounts.sql:78:0-111:6",
            "sources": [
              { "code.Query(0-accounts.sql:87:4-110:45) = SELECT account_id, date_month, revenue, revenue_core, revenue_aux, deals, acc...": {
                  "expressions": [
                    "code.Expression(0-accounts.sql:103:8-107:9) = SUM(revenue) OVER ( PARTITION BY account_id ORDER BY date_month ROWS BETWEEN ...",
                    "code.Expression(0-accounts.sql:97:8-101:11) = CASE WHEN c.region IN ('Americas', 'Europe') THEN 'North-West' WHEN c.region ..." ],
                  "location": "code.Location = 0-accounts.sql:87:4-110:45",
                  "sources": [
                    "code.Table(0-accounts.sql:108:9-108:25) = ?.accounts_revenue",
                    "code.Table(0-accounts.sql:109:13-109:21) = ?.accounts",
                    "code.Table(0-accounts.sql:110:18-110:27) = ?.countries" ],
                  "sql": "SELECT \n        account_id,\n        date_month,\n        revenue,\n        revenue_core,\n        revenue_aux,\n        deals,\n        accounts.name,\n        accounts.industry,\n        accounts.country,\n        CASE\n            WHEN c.region IN ('Americas', 'Europe') THEN 'North-West'\n            WHEN c.region IN ('Africa', 'Asia') THEN 'South-East'\n            ELSE NULL\n        END AS region_cluster,\n        accounts.priority,\n        SUM(revenue) OVER (\n            PARTITION BY account_id \n            ORDER BY date_month \n            ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\n        ) AS revenue_12m\n    FROM accounts_revenue\n        JOIN accounts USING (account_id)\n        LEFT JOIN countries c USING (country)" } } ],
            "sql": "SELECT \n    t.*,\n    CASE \n        WHEN t.revenue_12m <= 300 THEN 'Small'\n        WHEN t.revenue_12m > 300 AND t.revenue_12m <= 600 THEN 'Medium'\n        WHEN t.revenue_12m > 600 THEN 'Large'\n        ELSE NULL\n    END AS account_size\nFROM (\n    SELECT \n        account_id,\n        date_month,\n        revenue,\n        revenue_core,\n        revenue_aux,\n        deals,\n        accounts.name,\n        accounts.industry,\n        accounts.country,\n        CASE\n            WHEN c.region IN ('Americas', 'Europe') THEN 'North-West'\n            WHEN c.region IN ('Africa', 'Asia') THEN 'South-East'\n            ELSE NULL\n        END AS region_cluster,\n        accounts.priority,\n        SUM(revenue) OVER (\n            PARTITION BY account_id \n            ORDER BY date_month \n            ROWS BETWEEN 11 PRECEDING AND CURRENT ROW\n        ) AS revenue_12m\n    FROM accounts_revenue\n        JOIN accounts USING (account_id)\n        LEFT JOIN countries c USING (country)\n) AS t" } },
        { "code.Query(0-accounts.sql:25:0-44:6) = SELECT *, revenue / contract_duration_days AS revenue_day, revenue_core / con...": {
            "expressions": [
              "code.Expression(0-accounts.sql:27:4-27:36) = revenue / contract_duration_days",
              "code.Expression(0-accounts.sql:28:4-28:41) = revenue_core / contract_duration_days",
              "code.Expression(0-accounts.sql:29:4-29:40) = revenue_aux / contract_duration_days" ],
            "location": "code.Location = 0-accounts.sql:25:0-44:6",
            "sources": [
              { "code.Query(0-accounts.sql:31:4-43:80) = SELECT d.deal_id, d.account_id, d.contract_start_date, d.contract_end_date, j...": {
                  "expressions": [
                    "code.Expression(0-accounts.sql:36:8-36:77) = julianday(d.contract_end_date) - julianday(d.contract_start_date) + 1",
                    "code.Expression(0-accounts.sql:37:8-37:105) = SUM(CASE WHEN o.product IN ('Subscription Base', 'Subscription Premium') THEN...",
                    "code.Expression(0-accounts.sql:38:8-38:86) = SUM(CASE WHEN o.product IN ('Training', 'Consulting') THEN o.value ELSE 0 END)",
                    "code.Expression(0-accounts.sql:39:8-39:20) = SUM(o.value)" ],
                  "location": "code.Location = 0-accounts.sql:31:4-43:80",
                  "sources": [
                    "code.Table(0-accounts.sql:40:9-40:15) = ?.orders",
                    "code.Table(0-accounts.sql:41:13-41:18) = ?.deals" ],
                  "sql": "SELECT \n        d.deal_id,\n        d.account_id,\n        d.contract_start_date,\n        d.contract_end_date,\n        julianday(d.contract_end_date) - julianday(d.contract_start_date) + 1 AS contract_duration_days,\n        SUM(CASE WHEN o.product IN ('Subscription Base', 'Subscription Premium') THEN o.value ELSE 0 END) AS revenue_core,\n        SUM(CASE WHEN o.product IN ('Training', 'Consulting') THEN o.value ELSE 0 END) AS revenue_aux,\n        SUM(o.value) AS revenue\n    FROM orders o\n        JOIN deals d USING (deal_id, order_id)\n    WHERE d.stage = 4\n    GROUP BY d.deal_id, d.account_id, d.contract_start_date, d.contract_end_date" } } ],
            "sql": "SELECT \n    *,\n    revenue / contract_duration_days AS revenue_day,\n    revenue_core / contract_duration_days AS revenue_core_day,\n    revenue_aux / contract_duration_days AS revenue_aux_day\nFROM (\n    SELECT \n        d.deal_id,\n        d.account_id,\n        d.contract_start_date,\n        d.contract_end_date,\n        julianday(d.contract_end_date) - julianday(d.contract_start_date) + 1 AS contract_duration_days,\n        SUM(CASE WHEN o.product IN ('Subscription Base', 'Subscription Premium') THEN o.value ELSE 0 END) AS revenue_core,\n        SUM(CASE WHEN o.product IN ('Training', 'Consulting') THEN o.value ELSE 0 END) AS revenue_aux,\n        SUM(o.value) AS revenue\n    FROM orders o\n        JOIN deals d USING (deal_id, order_id)\n    WHERE d.stage = 4\n    GROUP BY d.deal_id, d.account_id, d.contract_start_date, d.contract_end_date\n) AS t" } },
        { "code.Query(0-accounts.sql:50:0-71:31) = SELECT t.date_month, t.account_id, AVG(t.deals) AS deals, SUM(t.revenue_core)...": {
            "expressions": [
              "code.Expression(0-accounts.sql:53:4-53:16) = AVG(t.deals)",
              "code.Expression(0-accounts.sql:54:4-54:23) = SUM(t.revenue_core)",
              "code.Expression(0-accounts.sql:55:4-55:22) = SUM(t.revenue_aux)",
              "code.Expression(0-accounts.sql:56:4-56:18) = SUM(t.revenue)" ],
            "location": "code.Location = 0-accounts.sql:50:0-71:31",
            "sources": [
              { "code.Query(0-accounts.sql:58:4-70:39) = SELECT dr.date_day, DATE(date_day, 'start of month') AS date_month, ds.accoun...": {
                  "expressions": [
                    "code.Expression(0-accounts.sql:60:8-60:40) = DATE(date_day, 'start of month')",
                    "code.Expression(0-accounts.sql:62:8-62:25) = COUNT(ds.deal_id)",
                    "code.Expression(0-accounts.sql:63:8-63:32) = SUM(ds.revenue_core_day)",
                    "code.Expression(0-accounts.sql:64:8-64:31) = SUM(ds.revenue_aux_day)",
                    "code.Expression(0-accounts.sql:65:8-65:27) = SUM(ds.revenue_day)",
                    "code.Expression(0-accounts.sql:68:16-69:57) = dr.date_day >= date(ds.contract_start_date) AND dr.date_day <= date(ds.contra..." ],
                  "location": "code.Location = 0-accounts.sql:58:4-70:39",
                  "sources": [
                    "code.Table(0-accounts.sql:66:9-66:20) = ?.date_ranges",
                    "code.Table(0-accounts.sql:67:18-67:30) = ?.deals_signed" ],
                  "sql": "SELECT \n        dr.date_day,\n        DATE(date_day, 'start of month') AS date_month,\n        ds.account_id,\n        COUNT(ds.deal_id) AS deals,\n        SUM(ds.revenue_core_day) AS revenue_core,\n        SUM(ds.revenue_aux_day) AS revenue_aux,\n        SUM(ds.revenue_day) AS revenue\n    FROM date_ranges dr\n        LEFT JOIN deals_signed ds \n            ON  dr.date_day >= date(ds.contract_start_date)\n            AND dr.date_day <= date(ds.contract_end_date)\n    GROUP BY dr.date_day, ds.account_id" } } ],
            "sql": "SELECT \n    t.date_month,\n    t.account_id,\n    AVG(t.deals) AS deals,\n    SUM(t.revenue_core) AS revenue_core,\n    SUM(t.revenue_aux) AS revenue_aux,\n    SUM(t.revenue) AS revenue\nFROM (\n    SELECT \n        dr.date_day,\n        DATE(date_day, 'start of month') AS date_month,\n        ds.account_id,\n        COUNT(ds.deal_id) AS deals,\n        SUM(ds.revenue_core_day) AS revenue_core,\n        SUM(ds.revenue_aux_day) AS revenue_aux,\n        SUM(ds.revenue_day) AS revenue\n    FROM date_ranges dr\n        LEFT JOIN deals_signed ds \n            ON  dr.date_day >= date(ds.contract_start_date)\n            AND dr.date_day <= date(ds.contract_end_date)\n    GROUP BY dr.date_day, ds.account_id) t\nGROUP BY account_id, date_month" } } ],
      "1-revenue.sql": [
        { "code.Query(1-revenue.sql:29:0-50:49) = SELECT accounts.name, region, CASE WHEN c.region IN ('Americas', 'Europe') TH...": {
            "expressions": [
              "code.Expression(1-revenue.sql:32:4-36:7) = CASE WHEN c.region IN ('Americas', 'Europe') THEN 'North-West' WHEN c.region ...",
              "code.Expression(1-revenue.sql:38:4-38:70) = IIF(accounts.industry = 'Information Technology', 'Tech', 'Other')",
              "code.Expression(1-revenue.sql:39:4-44:7) = CASE WHEN SUM(accounts_revenue.revenue) <= 300 THEN 'Small' WHEN SUM(accounts...",
              "code.Expression(1-revenue.sql:45:4-45:33) = SUM(accounts_revenue.revenue)" ],
            "location": "code.Location = 1-revenue.sql:29:0-50:49",
            "sources": [
              "code.Table(1-revenue.sql:46:5-46:13) = ?.accounts",
              "code.Table(1-revenue.sql:47:14-47:30) = ?.accounts_revenue",
              "code.Table(1-revenue.sql:48:14-48:23) = ?.countries" ],
            "sql": "SELECT\n    accounts.name,\n    region,\n    CASE\n        WHEN c.region IN ('Americas', 'Europe') THEN 'North-West'\n        WHEN c.region IN ('Africa', 'Asia') THEN 'South-East'\n        ELSE NULL\n    END AS cluster,\n    accounts.industry AS industry,\n    IIF(accounts.industry = 'Information Technology', 'Tech', 'Other') AS industry_tech,\n    CASE \n        WHEN SUM(accounts_revenue.revenue) <= 300 THEN 'Small'\n        WHEN SUM(accounts_revenue.revenue) > 300 AND SUM(accounts_revenue.revenue) <= 600 THEN 'Medium'\n        WHEN SUM(accounts_revenue.revenue) > 600 THEN 'Large'\n        ELSE NULL\n    END AS account_size,\n    SUM(accounts_revenue.revenue) AS revenue_12m\nFROM accounts\n    LEFT JOIN accounts_revenue USING (account_id)\n    LEFT JOIN countries c USING (country)\nWHERE accounts_revenue.date_month BETWEEN DATE('now', '-12 months') AND DATE('now')\nGROUP BY accounts.name, region, accounts.industry" } },
        { "code.Query(1-revenue.sql:4:0-25:52) = SELECT date(date_month, 'start of year') AS date_year, CASE WHEN c.region IN ...": {
            "expressions": [
              "code.Expression(1-revenue.sql:11:4-15:7) = CASE WHEN a.industry = 'Information Technology' THEN 'Tech' WHEN a.industry I...",
              "code.Expression(1-revenue.sql:17:4-17:19) = SUM(ar.revenue)",
              "code.Expression(1-revenue.sql:18:4-18:33) = COUNT(DISTINCT ar.account_id)",
              "code.Expression(1-revenue.sql:19:4-19:51) = SUM(ar.revenue) / COUNT(DISTINCT ar.account_id)",
              "code.Expression(1-revenue.sql:5:4-5:37) = date(date_month, 'start of year')",
              "code.Expression(1-revenue.sql:6:4-10:7) = CASE WHEN c.region IN ('Americas', 'Europe') THEN 'North-West' WHEN c.region ..." ],
            "location": "code.Location = 1-revenue.sql:4:0-25:52",
            "sources": [
              "code.Table(1-revenue.sql:20:5-20:21) = ?.accounts_revenue",
              "code.Table(1-revenue.sql:21:14-21:22) = ?.accounts",
              "code.Table(1-revenue.sql:22:14-22:23) = ?.countries",
              "code.Table(1-revenue.sql:23:14-23:26) = ?.accounts_360" ],
            "sql": "SELECT \n    date(date_month, 'start of year') AS date_year,\n    CASE\n        WHEN c.region IN ('Americas', 'Europe') THEN 'North-West'\n        WHEN c.region IN ('Africa', 'Asia') THEN 'South-East'\n        ELSE NULL\n    END AS region_cluster,\n    CASE \n        WHEN a.industry = 'Information Technology' THEN 'Tech'\n        WHEN a.industry IS NULL THEN NULL\n        ELSE 'Other'\n    END AS industry_cluster,\n    a360.account_size,\n    SUM(ar.revenue) AS revenue,\n    COUNT(DISTINCT ar.account_id) AS accounts,\n    SUM(ar.revenue) / COUNT(DISTINCT ar.account_id) AS revenue_per_account\nFROM accounts_revenue ar\n    LEFT JOIN accounts a USING (account_id)\n    LEFT JOIN countries c USING (country)\n    LEFT JOIN accounts_360 a360 USING (account_id, date_month)\nGROUP BY date_year, region_cluster, industry_cluster, a360.account_size\nORDER BY date_year, region_cluster, industry_cluster" } } ],
      "editor.sql": [
        { "code.Query(editor.sql:2:0-24:45) = SELECT date(date_month, 'start of year') AS date_year, -- This should cause a...": {
            "expressions": [
              "code.Expression(editor.sql:12:4-12:62) = IIF(a.industry = 'Information Technology', 'IT', 'Non-IT')",
              "code.Expression(editor.sql:13:4-13:19) = SUM(ar.revenue)",
              "code.Expression(editor.sql:14:4-14:33) = COUNT(DISTINCT ar.account_id)",
              "code.Expression(editor.sql:15:4-15:51) = SUM(ar.revenue) / COUNT(DISTINCT ar.account_id)",
              "code.Expression(editor.sql:3:4-3:37) = date(date_month, 'start of year')",
              "code.Expression(editor.sql:5:4-10:7) = CASE WHEN c.region IN ('Americas') THEN 'AMER' WHEN c.region IN ('Europe', 'A..." ],
            "location": "code.Location = editor.sql:2:0-24:45",
            "sources": [
              "code.Table(editor.sql:16:5-16:21) = ?.accounts_revenue",
              "code.Table(editor.sql:17:14-17:22) = ?.accounts",
              "code.Table(editor.sql:18:14-18:23) = ?.countries" ],
            "sql": "SELECT \n    date(date_month, 'start of year') AS date_year,\n    -- This should cause an error\n    CASE\n        WHEN c.region IN ('Americas') THEN 'AMER'\n        WHEN c.region IN ('Europe', 'Africa') THEN 'EMEA'\n        WHEN c.region = 'Asia' THEN 'APAC'\n        ELSE NULL\n    END AS macro_region,\n    -- This should case an error\n    IIF(a.industry = 'Information Technology', 'IT', 'Non-IT') AS industry_it,\n    SUM(ar.revenue) AS revenue,\n    COUNT(DISTINCT ar.account_id) AS accounts,\n    SUM(ar.revenue) / COUNT(DISTINCT ar.account_id) AS revenue_per_account\nFROM accounts_revenue ar\n    LEFT JOIN accounts a USING (account_id)\n    LEFT JOIN countries c USING (country)\nWHERE\n    -- This is appropriate, user can do ad-hoc filters for any subsets\n    a.industry IN ('Information Technology', 'Telecommunication Services')\n    -- This is appropriate, user can take any period\n    AND date_month BETWEEN DATE('now', '-24 months') AND DATE('now')\nGROUP BY date_year, macro_region, industry_it" } } ] } } }